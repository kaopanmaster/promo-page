<!doctype html>
<html lang="th">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>โปรโมชัน</title>

<style>
  body{margin:0;background:#000;color:#fff;font-family:system-ui,sans-serif}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:16px}
  .card{width:min(460px,100%);background:rgba(20,20,20,.9);border-radius:16px;padding:16px}
  .hero{width:100%;border-radius:12px}
  .btn{display:block;width:100%;padding:14px 16px;margin-top:14px;border-radius:12px;border:0;font-weight:700}
  .btn-primary{background:#14b866;color:#fff}
  .muted{color:#cfcfcf;font-size:14px}
</style>

<body>
<div class="wrap">
  <div class="card">
    <img class="hero" src="https://YOUR-CDN/promo-100.jpg" alt="promo" />
    <p class="muted" style="margin:10px 6px 0">แชร์กิจกรรมตามกติกาเพื่อรับสิทธิ์</p>
    <button id="shareBtn" class="btn btn-primary">กดแชร์กิจกรรม</button>
  </div>
</div>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = "ใส่-LIFF-ID-ของคุณ";

// ---------- 1) เตรียม Flex (2 การ์ดแบบ Carousel) ----------
function flexCarousel() {
  return {
    type: "flex",
    altText: "โปรโมชันแจกทุน + เกมมาแรง",
    contents: {
      type: "carousel",
      contents: [
        // การ์ดใบที่ 1 (แจกทุน 100)
        {
          type: "bubble",
          size: "mega",
          hero: {
            type: "image",
            url: "https://YOUR-CDN/promo-100.jpg", // ใส่รูปจริง HTTPS เท่านั้น
            size: "full",
            aspectMode: "cover",
            aspectRatio: "20:13"
          },
          body: {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              { type: "text", text: "สมัครรับทันที 100", weight: "bold", size: "xl" },
              { type: "text", text: "ทำกติกาให้ครบ แล้วรับสิทธิ์ได้เลย", size: "sm", color: "#aaaaaa", wrap: true }
            ]
          },
          footer: {
            type: "box",
            layout: "vertical",
            spacing: "md",
            contents: [
              {
                type: "button",
                style: "primary",
                action: { type: "uri", label: "ร่วมกิจกรรม", uri: "https://liff.line.me/" + LIFF_ID }
              },
              {
                type: "button",
                style: "link",
                action: { type: "uri", label: "เข้าสู่ระบบ", uri: "https://YOUR-DOMAIN/login" }
              }
            ]
          }
        },
        // การ์ดใบที่ 2 (BONUS TIME)
        {
          type: "bubble",
          size: "mega",
          hero: {
            type: "image",
            url: "https://YOUR-CDN/bonus-time.jpg",
            size: "full",
            aspectMode: "cover",
            aspectRatio: "20:13"
          },
          body: {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              { type: "text", text: "BONUS TIME", weight: "bold", size: "xl" },
              { type: "text", text: "อัตราเข้าฟีเจอร์สูงขึ้นช่วงเวลาพิเศษ", size: "sm", color: "#aaaaaa", wrap: true }
            ]
          },
          footer: {
            type: "box",
            layout: "vertical",
            spacing: "md",
            contents: [
              {
                type: "button",
                style: "primary",
                action: { type: "uri", label: "ทางเข้าเล่น", uri: "https://YOUR-DOMAIN/play" }
              },
              {
                type: "button",
                style: "link",
                action: { type: "uri", label: "สมัครสมาชิก", uri: "https://YOUR-DOMAIN/register" }
              }
            ]
          }
        }
      ]
    }
  };
}

// ---------- 2) Init LIFF ----------
async function boot() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isInClient() && !liff.isLoggedIn()) {
    liff.login(); return;
  }
  // ตรวจว่าใช้ shareTargetPicker ได้ไหม
  if (!liff.isApiAvailable('shareTargetPicker')) {
    alert('อุปกรณ์นี้ยังใช้การแชร์แบบเลือกห้องไม่ได้');
  }
}
boot();

// ---------- 3) ปุ่มแชร์ ----------
document.getElementById('shareBtn').addEventListener('click', async () => {
  try {
    const res = await liff.shareTargetPicker([ flexCarousel() ]);
    if (res) {
      // แชร์สำเร็จ (ผู้ใช้เลือกห้องแล้วส่งไปจริง)
      alert('แชร์สำเร็จ ขอบคุณครับ');
      // (ออปชัน) เก็บหลักฐานผู้แชร์
      // const p = await liff.getProfile();
      // await fetch('https://YOUR-WEBHOOK/log', { method:'POST', body: JSON.stringify(p) });
      liff.closeWindow();
    } else {
      // ผู้ใช้กดยกเลิก
    }
  } catch (err) {
    alert('แชร์ไม่สำเร็จ: ' + err.message);
  }
});
</script>
</body>
</html>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = "1661051007-qZ1jPaY3"; // ของคุณ

// ---- Flex สำหรับแชร์ (แก้รูป/ลิงก์เป็นของคุณ) ----
function flexCarousel(){ /* ... ใช้ตัวเดิมของคุณได้ ... */ }

// ---- บูต LIFF ให้ชัวร์ว่ามี token ----
async function boot(){
  try{
    await liff.init({ liffId: LIFF_ID });

    // บังคับให้มี token เสมอ (ทั้งใน/นอก LINE)
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return; // จะรีไดเรกต์กลับมาใหม่พร้อม token
    }

    // กันหลุด: ถ้า init แล้วแต่ยังไม่มี token ให้ logout/login อีกรอบ
    if (!liff.getAccessToken()) {
      liff.logout();
      liff.login({ redirectUri: location.href });
      return;
    }

    // แชร์ได้เฉพาะใน LINE app
    if (!liff.isInClient()) {
      // อยู่นอก LINE → ทำ fallback ได้ แต่อย่าเรียก shareTargetPicker
      console.log("นอก LINE: ใช้ลิงก์ https://line.me/R/msg/... เป็น fallback ได้");
    }
  }catch(e){
    alert("LIFF init error: " + e.message);
  }
}
boot();

// ---- ปุ่มแชร์ ----
document.getElementById('shareBtn').addEventListener('click', async () => {
  try{
    if (!liff.isInClient()) {
      alert('กรุณาเปิดลิงก์นี้ภายในแอป LINE'); 
      return;
    }
    if (!liff.isApiAvailable('shareTargetPicker')) {
      alert('เครื่องนี้ยังไม่รองรับ Share Target Picker');
      return;
    }
    const res = await liff.shareTargetPicker([ flexCarousel() ]);
    if (res) {
      alert('แชร์สำเร็จ ขอบคุณครับ');
      liff.closeWindow();
    }
  }catch(err){
    alert('แชร์ไม่สำเร็จ: ' + err.message);
  }
});
</script>
