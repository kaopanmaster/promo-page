<!doctype html>
<html lang="th">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>โปรโมชัน</title>

<style>
  body{margin:0;background:#000;color:#fff;font-family:system-ui,sans-serif}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:16px}
  .card{width:min(460px,100%);background:rgba(20,20,20,.9);border-radius:16px;padding:16px}
  .hero{width:100%;border-radius:12px}
  .btn{display:block;width:100%;padding:14px 16px;margin-top:14px;border-radius:12px;border:0;font-weight:700}
  .btn-primary{background:#14b866;color:#fff}
  .muted{color:#cfcfcf;font-size:14px}
</style>

<body>
<div class="wrap">
  <div class="card">
    <img class="hero" src="https://tga168.ai/wp-content/uploads/2024/12/TGA168-Pronew-1-3-1024x1024.webp" alt="promo" />
    <p class="muted" style="margin:10px 6px 0">แชร์กิจกรรมตามกติกาเพื่อรับสิทธิ์</p>
    <button id="shareBtn" class="btn btn-primary">กดแชร์กิจกรรม</button>
  </div>
</div>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = "2008144040-YZrXRWvr";  // ใช้ตัวนี้ตามที่คุณสร้าง

// --- Flex ที่จะส่ง (คงของเดิมไว้ได้) ---
function flexCarousel() { /* ... ของเดิมคุณ ... */ }

// --- บูต LIFF ให้ "มี token แน่ๆ" ไม่ว่าข้างใน/ข้างนอก LINE ---
async function ensureReady() {
  await liff.init({ liffId: LIFF_ID });

  // 1) ถ้ายังไม่ login ให้ login เสมอ (ทั้งใน/นอก LINE)
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return false;               // จะรีไดเรกต์กลับมาพร้อม token
  }

  // 2) กันเคส init แล้ว token ว่าง → รีล็อกอินอีกรอบ
  if (!liff.getAccessToken()) {
    liff.logout();
    liff.login({ redirectUri: location.href });
    return false;
  }
  return true;
}

(async () => {
  const ready = await ensureReady();
  if (!ready) return;

  // ปุ่มแชร์
  const btn = document.getElementById('shareBtn');
  btn.onclick = async () => {
    // แชร์ได้เฉพาะในแอป LINE
    if (!liff.isInClient()) {
      // พาคนเปิดใน LINE อัตโนมัติ
      location.href = 'https://liff.line.me/' + LIFF_ID + location.search;
      return;
    }
    if (!liff.isApiAvailable('shareTargetPicker')) {
      alert('เครื่องนี้ยังไม่รองรับการแชร์แบบเลือกห้อง');
      return;
    }
    try {
      const res = await liff.shareTargetPicker([ flexCarousel() ]);
      if (res) { alert('แชร์สำเร็จ'); liff.closeWindow(); }
    } catch (e) {
      alert('แชร์ไม่สำเร็จ: ' + e.message);
    }
  };
})();
</script>
</body>
</html>
