<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = "1661051007-qZ1jPaY3"; // ของคุณ

// ---- Flex สำหรับแชร์ (แก้รูป/ลิงก์เป็นของคุณ) ----
function flexCarousel(){ /* ... ใช้ตัวเดิมของคุณได้ ... */ }

// ---- บูต LIFF ให้ชัวร์ว่ามี token ----
async function boot(){
  try{
    await liff.init({ liffId: LIFF_ID });

    // บังคับให้มี token เสมอ (ทั้งใน/นอก LINE)
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return; // จะรีไดเรกต์กลับมาใหม่พร้อม token
    }

    // กันหลุด: ถ้า init แล้วแต่ยังไม่มี token ให้ logout/login อีกรอบ
    if (!liff.getAccessToken()) {
      liff.logout();
      liff.login({ redirectUri: location.href });
      return;
    }

    // แชร์ได้เฉพาะใน LINE app
    if (!liff.isInClient()) {
      // อยู่นอก LINE → ทำ fallback ได้ แต่อย่าเรียก shareTargetPicker
      console.log("นอก LINE: ใช้ลิงก์ https://line.me/R/msg/... เป็น fallback ได้");
    }
  }catch(e){
    alert("LIFF init error: " + e.message);
  }
}
boot();

// ---- ปุ่มแชร์ ----
document.getElementById('shareBtn').addEventListener('click', async () => {
  try{
    if (!liff.isInClient()) {
      alert('กรุณาเปิดลิงก์นี้ภายในแอป LINE'); 
      return;
    }
    if (!liff.isApiAvailable('shareTargetPicker')) {
      alert('เครื่องนี้ยังไม่รองรับ Share Target Picker');
      return;
    }
    const res = await liff.shareTargetPicker([ flexCarousel() ]);
    if (res) {
      alert('แชร์สำเร็จ ขอบคุณครับ');
      liff.closeWindow();
    }
  }catch(err){
    alert('แชร์ไม่สำเร็จ: ' + err.message);
  }
});
</script>
